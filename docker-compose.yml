services:
  ic-commerce:
    build: .
    # Give dfx time to shutdown cleanly and save state (default is 10s)
    stop_grace_period: 30s
    ports:
      # DFX replica - access canisters at http://localhost:4943
      - "4943:4943"
      # Vite dev server with hot reload
      - "5173:5173"
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src:delegated
      - ./public:/app/public:delegated
      # Persist dfx replica state (PocketIC state, canister data)
      # Mount network subdir only - NOT .local/share/dfx which contains binaries
      - dfx-network:/home/developer/.local/share/dfx/network
      # Persist dfx identity for consistent principals
      - dfx-config:/home/developer/.config/dfx
      # Persist canister IDs backup (since .dfx/local can't be volume-mounted)
      - dfx-backup:/app/.dfx-backup
      # Persist cargo cache for faster rebuilds
      - cargo-cache:/home/developer/.cargo/registry
      - cargo-git:/home/developer/.cargo/git
    environment:
      - VITE_DFX_NETWORK=local
    stdin_open: true
    tty: true

volumes:
  dfx-network:
  dfx-config:
  dfx-backup:
  cargo-cache:
  cargo-git:
